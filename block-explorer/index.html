<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekehi Network - Block Explorer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); min-height: 100vh; }
        .explorer-card { border: none; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); margin-bottom: 20px; transition: transform 0.3s; }
        .explorer-card:hover { transform: translateY(-2px); }
        .metric-card { text-align: center; }
        .metric-card i { color: #0984e3; }
        .metric-card h4 { color: #2d3436; margin: 10px 0 5px 0; }
        .hash-display { font-family: 'Courier New', monospace; font-size: 0.9rem; word-break: break-all; }
        .block-item, .tx-item { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px; border-left: 4px solid #0984e3; }
        .search-box { background: white; border-radius: 10px; padding: 20px; margin-bottom: 30px; }
        .detail-modal .modal-content { border-radius: 15px; }
        .badge-status { font-size: 0.8rem; }
        .data-table { font-size: 0.9rem; }
        .data-table th { background: #f8f9fa; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-cube me-2"></i>Ekehi Network Explorer
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a>
                <a class="nav-link" href="/api/docs">
                    <i class="fas fa-book"></i> API Docs
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Search Section -->
        <div class="search-box">
            <h4 class="text-center mb-4"><i class="fas fa-search me-2"></i>Blockchain Explorer</h4>
            <div class="row">
                <div class="col-md-8 offset-md-2">
                    <div class="input-group">
                        <input type="text" class="form-control form-control-lg" id="searchInput" 
                               placeholder="Search by block hash, transaction ID, or address...">
                        <button class="btn btn-primary btn-lg" onclick="performSearch()">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div class="mt-2 text-center">
                        <small class="text-muted">
                            Enter a block hash, transaction ID, or EKH address to explore the blockchain
                        </small>
                    </div>
                </div>
            </div>
            <div id="searchResults" class="mt-4"></div>
        </div>

        <!-- Network Stats -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card explorer-card metric-card">
                    <div class="card-body">
                        <i class="fas fa-cubes fa-2x mb-2"></i>
                        <h4 id="totalBlocks">-</h4>
                        <p class="mb-0">Total Blocks</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card explorer-card metric-card">
                    <div class="card-body">
                        <i class="fas fa-exchange-alt fa-2x mb-2"></i>
                        <h4 id="totalTx">-</h4>
                        <p class="mb-0">Transactions</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card explorer-card metric-card">
                    <div class="card-body">
                        <i class="fas fa-coins fa-2x mb-2"></i>
                        <h4 id="totalSupply">-</h4>
                        <p class="mb-0">Total Supply (EKH)</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card explorer-card metric-card">
                    <div class="card-body">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <h4 id="difficulty">-</h4>
                        <p class="mb-0">Difficulty</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="row">
            <!-- Recent Blocks -->
            <div class="col-lg-6">
                <div class="card explorer-card">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-cube me-2"></i>Recent Blocks</h5>
                        <button class="btn btn-light btn-sm" onclick="loadExplorerData()">
                            <i class="fas fa-refresh"></i>
                        </button>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <div id="recentBlocks">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Loading blocks...
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recent Transactions -->
            <div class="col-lg-6">
                <div class="card explorer-card">
                    <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Recent Transactions</h5>
                        <span class="badge bg-light text-dark" id="mempoolCount">0 pending</span>
                    </div>
                    <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                        <div id="recentTransactions">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i> Loading transactions...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Block Detail Modal -->
    <div class="modal fade" id="blockModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content detail-modal">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title"><i class="fas fa-cube me-2"></i>Block Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="blockModalBody">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> Loading block details...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Detail Modal -->
    <div class="modal fade" id="txModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content detail-modal">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Transaction Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="txModalBody">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> Loading transaction details...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Address Detail Modal -->
    <div class="modal fade" id="addressModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content detail-modal">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-wallet me-2"></i>Address Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="addressModalBody">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> Loading address details...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadExplorerData();
            setInterval(loadExplorerData, 15000); // Auto-refresh every 15 seconds

            // Handle enter key in search
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
        });

        async function loadExplorerData() {
            try {
                const response = await fetch('/api/explorer/data');
                const data = await response.json();

                if (data.isReady) {
                    displayBlocks(data.blocks || []);
                    displayTransactions(data.transactions || []);
                    updateStats(data.stats || {});
                } else {
                    showError('Explorer data not ready: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to load explorer data:', error);
                showError('Failed to load blockchain data');
            }
        }

        function updateStats(stats) {
            document.getElementById('totalBlocks').textContent = stats.totalBlocks || 0;
            document.getElementById('totalTx').textContent = stats.totalTransactions || 0;
            document.getElementById('totalSupply').textContent = (stats.totalSupply || 0).toFixed(1);
            document.getElementById('difficulty').textContent = stats.difficulty || 0;
        }

        function updateRecentBlocks(blocks) {
            const container = document.getElementById('recentBlocks');
            if (!blocks.length) {
                container.innerHTML = '<div class="text-center text-muted">No blocks available</div>';
                return;
            }

            const recentBlocks = blocks.slice(-10).reverse(); // Last 10 blocks, newest first
            container.innerHTML = recentBlocks.map(block => `
                <div class="block-item" style="cursor: pointer;" onclick="showBlockDetails('${block.hash}')">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-cube text-primary me-1"></i>
                                Block #${block.index}
                                ${block.index === 1 ? '<span class="badge bg-warning ms-2">Genesis</span>' : ''}
                            </h6>
                            <div class="hash-display text-muted small mb-2">
                                ${block.hash === '0' ? 'Genesis Block' : block.hash}
                            </div>
                            <div class="small">
                                <span class="badge bg-primary me-1">${block.transactions ? block.transactions.length : 0} TXs</span>
                                <span class="badge bg-secondary me-1">Difficulty: ${block.difficulty || 'N/A'}</span>
                                <span class="badge bg-info">Nonce: ${block.nonce || 'N/A'}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${formatTime(block.timestamp)}</small>
                            <br><small class="text-muted">${formatTimeAgo(block.timestamp)}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateRecentTransactions(transactions) {
            const container = document.getElementById('recentTransactions');
            if (!transactions.length) {
                container.innerHTML = '<div class="text-center text-muted">No pending transactions</div>';
                return;
            }

            container.innerHTML = transactions.slice(-20).reverse().map(tx => `
                <div class="tx-item" style="cursor: pointer;" onclick="showTransactionDetails('${tx.transactionId}')">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-exchange-alt text-success me-1"></i>
                                ${tx.amount} EKH
                                ${tx.sender === 'FAUCET' ? '<span class="badge bg-warning ms-2">Faucet</span>' : ''}
                                ${tx.sender === '00' ? '<span class="badge bg-info ms-2">Mining</span>' : ''}
                            </h6>
                            <div class="small text-muted mb-1">
                                <strong>From:</strong> ${formatAddress(tx.sender)}
                                <br><strong>To:</strong> ${formatAddress(tx.recipient)}
                            </div>
                            <div class="small">
                                <span class="badge bg-secondary">Fee: ${tx.fee || 0} EKH</span>
                                <span class="badge bg-outline-primary">ID: ${tx.transactionId ? tx.transactionId.substring(0, 8) + '...' : 'N/A'}</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${formatTime(tx.timestamp)}</small>
                            <br><small class="text-muted">${formatTimeAgo(tx.timestamp)}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                showAlert('Please enter a search term', 'warning');
                return;
            }

            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Searching...</div>';

            try {
                // Determine search type and perform appropriate search
                if (query.startsWith('EKH') && query.length === 51) {
                    await searchAddress(query);
                } else if (query.length === 64) {
                    await searchBlock(query);
                } else if (query.length === 32) {
                    await searchTransaction(query);
                } else {
                    resultsContainer.innerHTML = `
                        <div class="alert alert-warning">
                            <strong>Invalid search format</strong><br>
                            Please enter:<br>
                            • EKH address (51 characters starting with EKH)<br>
                            • Block hash (64 hex characters)<br>
                            • Transaction ID (32 hex characters)
                        </div>
                    `;
                }
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div class="alert alert-danger">
                        Search failed: ${error.message}
                    </div>
                `;
            }
        }

        async function searchBlock(hash) {
            const response = await fetch(`/block/${hash}`);
            const data = await response.json();

            if (data.block) {
                showBlockDetails(hash);
                document.getElementById('searchResults').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Block found! Details are shown below.
                    </div>
                `;
            } else {
                document.getElementById('searchResults').innerHTML = `
                    <div class="alert alert-warning">Block not found</div>
                `;
            }
        }

        async function searchTransaction(id) {
            const response = await fetch(`/transaction/${id}`);
            const data = await response.json();

            if (data.transaction) {
                showTransactionDetails(id);
                document.getElementById('searchResults').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Transaction found! Details are shown below.
                    </div>
                `;
            } else {
                document.getElementById('searchResults').innerHTML = `
                    <div class="alert alert-warning">Transaction not found</div>
                `;
            }
        }

        async function searchAddress(address) {
            const response = await fetch(`/address/${address}`);
            const data = await response.json();

            if (data.addressData) {
                showAddressDetails(address);
                document.getElementById('searchResults').innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Address found! Details are shown below.
                    </div>
                `;
            } else {
                document.getElementById('searchResults').innerHTML = `
                    <div class="alert alert-warning">Address not found or has no transactions</div>
                `;
            }
        }

        async function showBlockDetails(hash) {
            const modal = new bootstrap.Modal(document.getElementById('blockModal'));
            const body = document.getElementById('blockModalBody');

            body.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            modal.show();

            try {
                const response = await fetch(`/block/${hash}`);
                const data = await response.json();

                if (!data.block) {
                    throw new Error('Block not found');
                }

                const block = data.block;
                body.innerHTML = `
                    <table class="table table-striped data-table">
                        <tr><th>Block Index</th><td>#${block.index}</td></tr>
                        <tr><th>Hash</th><td class="hash-display">${block.hash}</td></tr>
                        <tr><th>Previous Hash</th><td class="hash-display">${block.previousBlockHash}</td></tr>
                        <tr><th>Timestamp</th><td>${formatTime(block.timestamp)} (${formatTimeAgo(block.timestamp)})</td></tr>
                        <tr><th>Transactions</th><td>${block.transactions ? block.transactions.length : 0}</td></tr>
                        <tr><th>Difficulty</th><td>${block.difficulty || 'N/A'}</td></tr>
                        <tr><th>Nonce</th><td>${block.nonce || 'N/A'}</td></tr>
                        <tr><th>Total Fees</th><td>${block.totalFees || 0} EKH</td></tr>
                        <tr><th>Network</th><td>${block.network || 'Ekehi Network'}</td></tr>
                        <tr><th>Version</th><td>${block.version || '1.0.0'}</td></tr>
                    </table>

                    ${block.transactions && block.transactions.length > 0 ? `
                        <h6 class="mt-4 mb-3"><i class="fas fa-list me-2"></i>Transactions in this Block</h6>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${block.transactions.map((tx, index) => `
                                <div class="card mb-2">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <strong>${tx.amount} EKH</strong>
                                                ${tx.sender === '00' ? '<span class="badge bg-info ms-1">Mining Reward</span>' : ''}
                                                ${tx.sender === 'FAUCET' ? '<span class="badge bg-warning ms-1">Faucet</span>' : ''}
                                                <br><small class="text-muted">
                                                    ${formatAddress(tx.sender)} → ${formatAddress(tx.recipient)}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <small>Fee: ${tx.fee || 0} EKH</small>
                                                <br><small class="text-muted">${tx.transactionId ? tx.transactionId.substring(0, 16) + '...' : 'N/A'}</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p class="text-muted mt-4">No transactions in this block</p>'}
                `;
            } catch (error) {
                body.innerHTML = `<div class="alert alert-danger">Failed to load block details: ${error.message}</div>`;
            }
        }

        async function showTransactionDetails(id) {
            const modal = new bootstrap.Modal(document.getElementById('txModal'));
            const body = document.getElementById('txModalBody');

            body.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            modal.show();

            try {
                const response = await fetch(`/transaction/${id}`);
                const data = await response.json();

                if (!data.transaction) {
                    throw new Error('Transaction not found');
                }

                const tx = data.transaction;
                const block = data.block;

                body.innerHTML = `
                    <table class="table table-striped data-table">
                        <tr><th>Transaction ID</th><td class="hash-display">${tx.transactionId}</td></tr>
                        <tr><th>Amount</th><td><strong>${tx.amount} EKH</strong></td></tr>
                        <tr><th>Sender</th><td class="hash-display">${tx.sender}${tx.sender === '00' ? ' <span class="badge bg-info">Mining</span>' : ''}${tx.sender === 'FAUCET' ? ' <span class="badge bg-warning">Faucet</span>' : ''}</td></tr>
                        <tr><th>Recipient</th><td class="hash-display">${tx.recipient}</td></tr>
                        <tr><th>Fee</th><td>${tx.fee || 0} EKH</td></tr>
                        <tr><th>Timestamp</th><td>${formatTime(tx.timestamp)} (${formatTimeAgo(tx.timestamp)})</td></tr>
                        <tr><th>Network</th><td>${tx.network || 'Ekehi Network'}</td></tr>
                        ${block ? `
                            <tr><th>Block</th><td>
                                <a href="#" onclick="showBlockDetails('${block.hash}')" class="text-decoration-none">
                                    Block #${block.index}
                                </a>
                            </td></tr>
                            <tr><th>Confirmations</th><td><span class="badge bg-success">Confirmed</span></td></tr>
                        ` : `
                            <tr><th>Status</th><td><span class="badge bg-warning">Pending</span></td></tr>
                        `}
                    </table>
                `;
            } catch (error) {
                body.innerHTML = `<div class="alert alert-danger">Failed to load transaction details: ${error.message}</div>`;
            }
        }

        async function showAddressDetails(address) {
            const modal = new bootstrap.Modal(document.getElementById('addressModal'));
            const body = document.getElementById('addressModalBody');

            body.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading...</div>';
            modal.show();

            try {
                const response = await fetch(`/address/${address}`);
                const data = await response.json();

                if (!data.addressData) {
                    throw new Error('Address data not found');
                }

                const addrData = data.addressData;

                body.innerHTML = `
                    <table class="table table-striped data-table">
                        <tr><th>Address</th><td class="hash-display">${address}</td></tr>
                        <tr><th>Balance</th><td><strong>${addrData.addressBalance} EKH</strong></td></tr>
                        <tr><th>Total Received</th><td>${addrData.totalReceived} EKH</td></tr>
                        <tr><th>Total Sent</th><td>${addrData.totalSent} EKH</td></tr>
                        <tr><th>Total Fees</th><td>${addrData.totalFees} EKH</td></tr>
                        <tr><th>Transaction Count</th><td>${addrData.transactionCount}</td></tr>
                    </table>

                    ${addrData.addressTransactions && addrData.addressTransactions.length > 0 ? `
                        <h6 class="mt-4 mb-3"><i class="fas fa-history me-2"></i>Transaction History</h6>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${addrData.addressTransactions.reverse().map(tx => `
                                <div class="card mb-2">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between">
                                            <div>
                                                <strong>${tx.amount} EKH</strong>
                                                ${tx.recipient === address ? '<span class="badge bg-success ms-1">Received</span>' : '<span class="badge bg-danger ms-1">Sent</span>'}
                                                ${tx.sender === '00' ? '<span class="badge bg-info ms-1">Mining</span>' : ''}
                                                ${tx.sender === 'FAUCET' ? '<span class="badge bg-warning ms-1">Faucet</span>' : ''}
                                                <br><small class="text-muted">
                                                    ${tx.recipient === address ? 'From: ' + formatAddress(tx.sender) : 'To: ' + formatAddress(tx.recipient)}
                                                </small>
                                            </div>
                                            <div class="text-end">
                                                <small>${formatTime(tx.timestamp)}</small>
                                                <br><small class="text-muted">Fee: ${tx.fee || 0} EKH</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p class="text-muted mt-4">No transactions found for this address</p>'}
                `;
            } catch (error) {
                body.innerHTML = `<div class="alert alert-danger">Failed to load address details: ${error.message}</div>`;
            }
        }

        function formatAddress(address) {
            if (address === '00') return 'Mining Reward';
            if (address === 'FAUCET') return 'Testnet Faucet';
            if (address && address.length > 20) {
                return address.substring(0, 10) + '...' + address.substring(address.length - 10);
            }
            return address;
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleString();
        }

        function formatTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            const seconds = Math.floor(diff / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days} day${days > 1 ? 's' : ''} ago`;
            if (hours > 0) return `${hours} hour${hours > 1 ? 's' : ''} ago`;
            if (minutes > 0) return `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
            return `${seconds} second${seconds > 1 ? 's' : ''} ago`;
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>