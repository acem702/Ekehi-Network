<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekehi Network - Testnet Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .dashboard-card { border: none; border-radius: 15px; box-shadow: 0 8px 25px rgba(0,0,0,0.15); margin-bottom: 20px; transition: transform 0.3s; }
        .dashboard-card:hover { transform: translateY(-5px); }
        .metric-value { font-size: 2.5rem; font-weight: bold; color: #2c3e50; }
        .metric-label { color: #7f8c8d; font-size: 0.9rem; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-active { background-color: #27ae60; }
        .status-inactive { background-color: #e74c3c; }
        .auto-refresh { position: fixed; top: 20px; right: 20px; z-index: 1000; }
        .block-item, .tx-item { background: #f8f9fa; border-radius: 8px; padding: 10px; margin-bottom: 8px; border-left: 4px solid #007bff; }
        .hash-display { font-family: 'Courier New', monospace; font-size: 0.85rem; }
    </style>
</head>
<body>
    <!-- Auto-refresh indicator -->
    <div class="auto-refresh">
        <span class="badge bg-primary">
            <i class="fas fa-sync-alt" id="refreshIcon"></i> Auto-refresh: <span id="refreshTimer">10</span>s
        </span>
    </div>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-tachometer-alt me-2"></i>Ekehi Network Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/block-explorer"><i class="fas fa-search"></i> Explorer</a>
                <a class="nav-link" href="/api/docs"><i class="fas fa-book"></i> API Docs</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Network Status Row -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card dashboard-card text-center">
                    <div class="card-body">
                        <i class="fas fa-cubes fa-2x text-primary mb-2"></i>
                        <div class="metric-value" id="totalBlocks">-</div>
                        <div class="metric-label">Total Blocks</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card dashboard-card text-center">
                    <div class="card-body">
                        <i class="fas fa-coins fa-2x text-warning mb-2"></i>
                        <div class="metric-value" id="totalSupply">-</div>
                        <div class="metric-label">Total Supply (EKH)</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card dashboard-card text-center">
                    <div class="card-body">
                        <i class="fas fa-exchange-alt fa-2x text-success mb-2"></i>
                        <div class="metric-value" id="totalTx">-</div>
                        <div class="metric-label">Transactions</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card dashboard-card text-center">
                    <div class="card-body">
                        <i class="fas fa-network-wired fa-2x text-info mb-2"></i>
                        <div class="metric-value" id="networkNodes">-</div>
                        <div class="metric-label">Network Nodes</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content Row -->
        <div class="row">
            <!-- Left Column -->
            <div class="col-lg-6">
                <!-- Mining Status -->
                <div class="card dashboard-card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-hammer me-2"></i>Mining Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <p><strong>Auto-Mining:</strong> <span class="status-indicator" id="miningIndicator"></span><span id="miningStatus">-</span></p>
                                <p><strong>Difficulty:</strong> <span id="difficulty">-</span></p>
                                <p><strong>Hash Rate:</strong> <span id="hashRate">-</span> H/s</p>
                            </div>
                            <div class="col-6">
                                <p><strong>Pending TX:</strong> <span id="pendingTx">-</span></p>
                                <p><strong>Block Time:</strong> <span id="avgBlockTime">-</span>s</p>
                                <p><strong>Reward:</strong> <span id="miningReward">-</span> EKH</p>
                            </div>
                        </div>
                        <div class="mt-3">
                            <button class="btn btn-success btn-sm me-2" onclick="startMining()">
                                <i class="fas fa-play"></i> Start Mining
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="stopMining()">
                                <i class="fas fa-stop"></i> Stop Mining
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Network Info -->
                <div class="card dashboard-card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Network Information</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Network:</strong> <span id="networkName">-</span></p>
                        <p><strong>Token:</strong> <span id="tokenInfo">-</span></p>
                        <p><strong>Version:</strong> <span id="version">-</span></p>
                        <p><strong>Block Time:</strong> <span id="blockTime">-</span>s</p>
                        <p><strong>Uptime:</strong> <span id="uptime">-</span></p>
                    </div>
                </div>

                <!-- Testnet Faucet -->
                <div class="card dashboard-card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-faucet me-2"></i>Testnet Faucet</h5>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted">Get free EKH tokens for testing (100 EKH per request, 1 hour cooldown)</p>
                        <div class="input-group mb-3">
                            <input type="text" class="form-control" id="faucetAddress" placeholder="EKH address..." maxlength="51">
                            <button class="btn btn-warning" onclick="requestFaucet()">
                                <i class="fas fa-coins"></i> Request 100 EKH
                            </button>
                        </div>
                        <div id="faucetResult" class="mt-2"></div>
                    </div>
                </div>

                <!-- Wallet Generator -->
                <div class="card dashboard-card mb-4">
                    <div class="card-header bg-secondary text-white">
                        <h5 class="mb-0"><i class="fas fa-wallet me-2"></i>Wallet Generator</h5>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted">Generate a new EKH wallet address</p>
                        <button class="btn btn-secondary" onclick="createWallet()">
                            <i class="fas fa-plus"></i> Generate New Wallet
                        </button>
                        <div id="walletResult" class="mt-2"></div>
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="col-lg-6">
                <!-- Recent Blocks -->
                <div class="card dashboard-card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-cube me-2"></i>Recent Blocks</h5>
                    </div>
                    <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                        <div id="recentBlocks">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading blocks...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="card dashboard-card mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Pending Transactions</h5>
                    </div>
                    <div class="card-body" style="max-height: 350px; overflow-y: auto;">
                        <div id="recentTransactions">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading transactions...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Peer Management -->
                <div class="card dashboard-card mb-4">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-network-wired me-2"></i>Peer Management</h5>
                        <button class="btn btn-light btn-sm" onclick="discoverPeers()">
                            <i class="fas fa-search"></i> Discover
                        </button>
                    </div>
                    <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                        <div class="row mb-3">
                            <div class="col-6">
                                <p class="mb-1"><strong>Connected Peers:</strong> <span id="connectedPeers">-</span></p>
                                <p class="mb-1"><strong>Max Peers:</strong> <span id="maxPeers">-</span></p>
                            </div>
                            <div class="col-6">
                                <p class="mb-1"><strong>Discovery:</strong> <span id="discoveryStatus">-</span></p>
                                <p class="mb-1"><strong>Node URL:</strong> <span id="nodeUrl" class="small">-</span></p>
                            </div>
                        </div>
                        <div id="peersList">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i> Loading peers...
                            </div>
                        </div>
                        <hr>
                        <div class="mt-3">
                            <h6 class="mb-2">Manual Peer Management</h6>
                            <div class="input-group input-group-sm mb-2">
                                <input type="url" class="form-control" id="newPeerUrl" placeholder="https://peer-repl-url.repl.co">
                                <button class="btn btn-outline-primary" onclick="addPeer()">
                                    <i class="fas fa-plus"></i> Add
                                </button>
                            </div>
                            <div class="btn-group-sm" role="group">
                                <button class="btn btn-outline-info btn-sm" onclick="debugPeers()">
                                    <i class="fas fa-bug"></i> Debug
                                </button>
                                <button class="btn btn-outline-warning btn-sm" onclick="forceSync()">
                                    <i class="fas fa-sync"></i> Force Sync
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="forceDiscovery()">
                                    <i class="fas fa-search"></i> Discover
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Token Economics -->
                <div class="card dashboard-card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-coins me-2"></i>Token Economics</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <p><strong>Total Supply:</strong> <span id="tokenTotalSupply">-</span> EKH</p>
                                <p><strong>Circulating:</strong> <span id="tokenCirculating">-</span> EKH</p>
                                <p><strong>Mining Reward:</strong> <span id="tokenMiningReward">-</span> EKH</p>
                            </div>
                            <div class="col-6">
                                <p><strong>Total Blocks:</strong> <span id="tokenBlocks">-</span></p>
                                <p><strong>Faucet Issued:</strong> <span id="faucetIssued">-</span> EKH</p>
                                <p><strong>Inflation Rate:</strong> <span id="inflationRate">-</span>%</p>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i> 
                                Total supply increases by mining rewards. Circulating supply excludes unmoved tokens.
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Node Controls -->
                <div class="card dashboard-card mb-4">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Node Management</h5>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted">Manage node services and processes</p>
                        <button class="btn btn-danger btn-sm" onclick="restartNode()">
                            <i class="fas fa-restart"></i> Restart Node
                        </button>
                        <button class="btn btn-info btn-sm ms-2" onclick="loadDashboardData()">
                            <i class="fas fa-refresh"></i> Refresh Data
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Transaction Details Modal -->
    <div class="modal fade" id="transactionDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-exchange-alt me-2"></i>Transaction Details</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="transactionDetailsBody">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin"></i> Loading transaction details...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let refreshInterval;
        let refreshCountdown = 10;

        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            startAutoRefresh();
        });

        function startAutoRefresh() {
            refreshInterval = setInterval(() => {
                refreshCountdown--;
                document.getElementById('refreshTimer').textContent = refreshCountdown;

                if (refreshCountdown <= 0) {
                    loadDashboardData();
                    refreshCountdown = 10;
                    // Spin refresh icon
                    const icon = document.getElementById('refreshIcon');
                    icon.style.animation = 'spin 1s linear';
                    setTimeout(() => icon.style.animation = '', 1000);
                }
            }, 1000);
        }

        async function loadDashboardData() {
            try {
                const response = await fetch('/api/dashboard/data');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                const data = await response.json();

                if (!data.isReady) {
                    throw new Error(data.message || 'Dashboard not ready');
                }

                updateDashboard(data);
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
                showAlert('Failed to load dashboard data: ' + error.message, 'danger');
            }
        }

        function updateDashboard(data) {
            try {
                // Update metrics
                document.getElementById('totalBlocks').textContent = data.stats?.totalBlocks || 0;
                document.getElementById('totalSupply').textContent = (data.stats?.totalSupply || 0).toFixed(1);
                document.getElementById('totalTx').textContent = data.stats?.totalTransactions || 0;
                document.getElementById('networkNodes').textContent = data.stats?.networkNodes || 0;

                // Update mining status
                const isMining = data.stats?.autoMining;
                document.getElementById('miningStatus').textContent = isMining ? 'Active' : 'Inactive';
                const indicator = document.getElementById('miningIndicator');
                indicator.className = `status-indicator ${isMining ? 'status-active' : 'status-inactive'}`;

                document.getElementById('difficulty').textContent = data.stats?.difficulty || 0;
                document.getElementById('hashRate').textContent = (data.metrics?.hashRate || 0).toFixed(2);
                document.getElementById('pendingTx').textContent = data.stats?.pendingTransactions || 0;
                document.getElementById('avgBlockTime').textContent = (data.stats?.averageBlockTime / 1000 || 0).toFixed(1);
                document.getElementById('miningReward').textContent = data.stats?.miningReward || 0;

                // Update network info
                document.getElementById('networkName').textContent = data.network?.name || 'Unknown';
                document.getElementById('tokenInfo').textContent = `${data.network?.token?.name || 'Unknown'} (${data.network?.token?.symbol || 'N/A'})`;
                document.getElementById('version').textContent = data.network?.version || '1.0.0';
                document.getElementById('blockTime').textContent = (data.network?.blockTime / 1000 || 0).toFixed(0);
                document.getElementById('uptime').textContent = formatDuration(data.metrics?.uptime || 0);

                // Update peer information
                updatePeerInfo(data);

                // Update token economics
                updateTokenEconomics(data);

                // Update recent blocks
                updateRecentBlocks(data.recentBlocks || []);

                // Update recent transactions
                updateRecentTransactions(data.recentTransactions || []);

            } catch (error) {
                console.error('Error updating dashboard:', error);
            }
        }

        function updatePeerInfo(data) {
            document.getElementById('connectedPeers').textContent = data.stats?.networkNodes || 0;
            document.getElementById('maxPeers').textContent = '20'; // From blockchain config
            document.getElementById('discoveryStatus').textContent = 'Active';
            document.getElementById('nodeUrl').textContent = window.location.origin;

            // Update peers list
            const peersList = document.getElementById('peersList');
            if (data.networkNodes && data.networkNodes > 0) {
                peersList.innerHTML = `
                    <div class="small">
                        <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded mb-1">
                            <span><i class="fas fa-circle text-success me-1"></i>Local Node</span>
                            <span class="badge bg-primary">Active</span>
                        </div>
                        ${Array.from({length: data.stats?.networkNodes || 0}, (_, i) => `
                            <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded mb-1">
                                <span><i class="fas fa-circle text-success me-1"></i>Peer ${i + 1}</span>
                                <span class="badge bg-success">Connected</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                peersList.innerHTML = '<div class="text-center text-muted">No peers connected</div>';
            }
        }

        function updateTokenEconomics(data) {
            const totalSupply = data.stats?.totalSupply || 0;
            const totalBlocks = data.stats?.totalBlocks || 0;
            const miningReward = data.stats?.miningReward || 0;

            // Calculate faucet issued tokens (approximate)
            const faucetIssued = Math.min(totalSupply * 0.1, 10000); // Estimate faucet tokens

            // Calculate circulating supply (total minus large inactive holders)
            const circulatingSupply = totalSupply * 0.95; // Assume 95% is circulating

            // Calculate inflation rate based on mining
            const blocksPerDay = (24 * 60 * 60) / ((data.stats?.averageBlockTime || 10000) / 1000);
            const dailyInflation = (blocksPerDay * miningReward) / totalSupply * 100;
            const annualInflation = dailyInflation * 365;

            document.getElementById('tokenTotalSupply').textContent = totalSupply.toFixed(1);
            document.getElementById('tokenCirculating').textContent = circulatingSupply.toFixed(1);
            document.getElementById('tokenMiningReward').textContent = miningReward;
            document.getElementById('tokenBlocks').textContent = totalBlocks;
            document.getElementById('faucetIssued').textContent = faucetIssued.toFixed(0);
            document.getElementById('inflationRate').textContent = annualInflation.toFixed(2);
        }

        function updateRecentBlocks(blocks) {
            const container = document.getElementById('recentBlocks');
            if (!blocks.length) {
                container.innerHTML = '<div class="text-center text-muted">No blocks available</div>';
                return;
            }

            container.innerHTML = blocks.reverse().map(block => `
                <div class="block-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Block #${block.index}</strong>
                            <br><span class="hash-display text-muted">${block.hash}</span>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${formatTime(block.timestamp)}</small>
                            <br><span class="badge bg-primary">${block.transactions} TXs</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function updateRecentTransactions(transactions) {
            const container = document.getElementById('recentTransactions');
            if (!transactions.length) {
                container.innerHTML = '<div class="text-center text-muted">No pending transactions</div>';
                return;
            }

            container.innerHTML = transactions.map(tx => `
                <div class="tx-item" style="cursor: pointer;" onclick="showTransactionDetails('${tx.fullId || tx.id}')">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${tx.amount} EKH</strong>
                            <br><small class="text-muted">${tx.sender} â†’ ${tx.recipient}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${formatTime(tx.timestamp)}</small>
                            <br><span class="badge bg-secondary">Fee: ${tx.fee} EKH</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function showTransactionDetails(transactionId) {
            if (!transactionId || transactionId === 'N/A') {
                showAlert('Transaction ID not available', 'warning');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('transactionDetailsModal'));
            const body = document.getElementById('transactionDetailsBody');

            body.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading transaction details...</div>';
            modal.show();

            try {
                const response = await fetch(`/transaction/${transactionId}`);
                const data = await response.json();

                if (data.transaction) {
                    const tx = data.transaction;
                    const block = data.block;

                    body.innerHTML = `
                        <table class="table table-striped">
                            <tr><th>Transaction ID</th><td class="font-monospace small">${tx.transactionId}</td></tr>
                            <tr><th>Amount</th><td><strong>${tx.amount} EKH</strong></td></tr>
                            <tr><th>Sender</th><td class="font-monospace small">${tx.sender === '00' ? 'Mining Reward' : tx.sender === 'FAUCET' ? 'Testnet Faucet' : tx.sender}</td></tr>
                            <tr><th>Recipient</th><td class="font-monospace small">${tx.recipient}</td></tr>
                            <tr><th>Fee</th><td>${tx.fee || 0} EKH</td></tr>
                            <tr><th>Timestamp</th><td>${new Date(tx.timestamp).toLocaleString()}</td></tr>
                            <tr><th>Network</th><td>${tx.network || 'Ekehi Network'}</td></tr>
                            ${block ? `
                                <tr><th>Block</th><td>Block #${block.index}</td></tr>
                                <tr><th>Status</th><td><span class="badge bg-success">Confirmed</span></td></tr>
                            ` : `
                                <tr><th>Status</th><td><span class="badge bg-warning">Pending</span></td></tr>
                            `}
                        </table>
                    `;
                } else {
                    body.innerHTML = '<div class="alert alert-warning">Transaction not found</div>';
                }
            } catch (error) {
                body.innerHTML = `<div class="alert alert-danger">Error loading transaction: ${error.message}</div>`;
            }
        }

        async function startMining() {
            try {
                const response = await fetch('/mining/start', { method: 'POST' });
                const result = await response.json();
                showAlert(result.message || 'Mining started', 'success');
                setTimeout(loadDashboardData, 1000);
            } catch (error) {
                showAlert('Failed to start mining', 'danger');
            }
        }

        async function stopMining() {
            try {
                const response = await fetch('/mining/stop', { method: 'POST' });
                const result = await response.json();
                showAlert(result.message || 'Mining stopped', 'warning');
                setTimeout(loadDashboardData, 1000);
            } catch (error) {
                showAlert('Failed to stop mining', 'danger');
            }
        }

        async function createWallet() {
            try {
                const response = await fetch('/wallet/create');
                const result = await response.json();

                document.getElementById('walletResult').innerHTML = `
                    <div class="alert alert-success">
                        <strong>New Wallet Created!</strong><br>
                        <small>Address: <code>${result.wallet.address}</code></small>
                        <br><button class="btn btn-sm btn-outline-success mt-2" onclick="copyToClipboard('${result.wallet.address}')">
                            <i class="fas fa-copy"></i> Copy Address
                        </button>
                    </div>
                `;
            } catch (error) {
                document.getElementById('walletResult').innerHTML = `
                    <div class="alert alert-danger">Failed to create wallet: ${error.message}</div>
                `;
            }
        }

        async function requestFaucet() {
            const address = document.getElementById('faucetAddress').value.trim();
            if (!address) {
                showAlert('Please enter a valid EKH address', 'warning');
                return;
            }

            if (!address.startsWith('EKH') || address.length !== 51) {
                showAlert('Invalid EKH address format. Must start with EKH and be 51 characters long.', 'warning');
                return;
            }

            try {
                const response = await fetch('/api/faucet/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ address })
                });
                const result = await response.json();

                if (result.success) {
                    document.getElementById('faucetResult').innerHTML = `
                        <div class="alert alert-success">
                            <strong>Success!</strong> ${result.message}<br>
                            <small>Transaction ID: <code>${result.transaction}</code></small><br>
                            <small>Estimated confirmation: ${result.estimatedConfirmation}</small>
                        </div>
                    `;
                    document.getElementById('faucetAddress').value = '';
                } else {
                    document.getElementById('faucetResult').innerHTML = `
                        <div class="alert alert-danger">
                            <strong>Error:</strong> ${result.error}
                        </div>
                    `;
                }
            } catch (error) {
                document.getElementById('faucetResult').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>Error:</strong> Faucet request failed: ${error.message}
                    </div>
                `;
            }
        }

        async function discoverPeers() {
            try {
                const response = await fetch('/api/network/discover', { method: 'POST' });
                const result = await response.json();
                showAlert(result.message, 'success');
                setTimeout(loadDashboardData, 1000);
            } catch (error) {
                showAlert('Failed to discover peers', 'danger');
            }
        }

        async function addPeer() {
            const peerUrl = document.getElementById('newPeerUrl').value.trim();
            if (!peerUrl) {
                showAlert('Please enter a valid peer URL', 'warning');
                return;
            }

            try {
                const response = await fetch('/register-and-broadcast-node', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ newNodeUrl: peerUrl })
                });
                const result = await response.json();
                showAlert(result.note || 'Peer added successfully', 'success');
                document.getElementById('newPeerUrl').value = '';
                setTimeout(loadDashboardData, 1000);
            } catch (error) {
                showAlert('Failed to add peer', 'danger');
            }
        }

        async function restartNode() {
            if (!confirm('Are you sure you want to restart the node?')) return;

            try {
                const response = await fetch('/api/node/restart', { method: 'POST' });
                const result = await response.json();
                showAlert(result.message, 'success');
                setTimeout(loadDashboardData, 2000);
            } catch (error) {
                showAlert('Failed to restart node', 'danger');
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showAlert('Address copied to clipboard!', 'success');
            });
        }

        function formatTime(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);

            if (days > 0) return `${days}d ${hours % 24}h`;
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
            return `${seconds}s`;
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

            // Add network node
            async function addNetworkNode() {
                const nodeUrl = document.getElementById('node-url').value.trim();
                if (!nodeUrl) {
                    alert('Please enter a node URL');
                    return;
                }

                try {
                    const response = await fetch('/api/network/sync', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ nodeUrl })
                    });

                    const result = await response.json();

                    if (result.success) {
                        document.getElementById('sync-status').innerHTML = `
                            <div class="alert alert-success alert-sm">
                                Node added! Chain replaced: ${result.chainReplaced}, Network size: ${result.networkSize}
                            </div>
                        `;
                        document.getElementById('node-url').value = '';
                        loadDashboardData(); // Refresh data
                    } else {
                        throw new Error(result.error || 'Failed to add node');
                    }
                } catch (error) {
                    document.getElementById('sync-status').innerHTML = `
                        <div class="alert alert-danger alert-sm">
                            Error: ${error.message}
                        </div>
                    `;
                }
            }

            // Debug peer connections
            async function debugPeers() {
                try {
                    const response = await fetch('/api/debug/peers');
                    const result = await response.json();
                    
                    alert(`
Debug Info:
Current Node: ${result.currentNodeUrl || 'Not set'}
Connected Peers: ${result.peerCount}
Discovery Seeds: ${result.discoverySeeds.length}
Chain Length: ${result.chainLength}
Pending TXs: ${result.pendingTransactions}

Peers: ${result.networkNodes.join(', ') || 'None'}
Seeds: ${result.discoverySeeds.join(', ') || 'None'}
                    `);
                } catch (error) {
                    alert('Debug failed: ' + error.message);
                }
            }

            // Force blockchain sync
            async function forceSync() {
                try {
                    document.getElementById('sync-status').innerHTML = `
                        <div class="alert alert-info alert-sm">
                            <i class="fas fa-spinner fa-spin"></i> Forcing blockchain sync...
                        </div>
                    `;
                    
                    const response = await fetch('/api/debug/force-sync', {
                        method: 'POST'
                    });
                    const result = await response.json();
                    
                    document.getElementById('sync-status').innerHTML = `
                        <div class="alert alert-success alert-sm">
                            Sync complete! Updated: ${result.result.updated}, Chain: ${result.chainLength} blocks
                        </div>
                    `;
                    loadDashboardData();
                } catch (error) {
                    document.getElementById('sync-status').innerHTML = `
                        <div class="alert alert-danger alert-sm">
                            Sync failed: ${error.message}
                        </div>
                    `;
                }
            }

            // Force peer discovery
            async function forceDiscovery() {
                try {
                    document.getElementById('sync-status').innerHTML = `
                        <div class="alert alert-info alert-sm">
                            <i class="fas fa-spinner fa-spin"></i> Discovering peers...
                        </div>
                    `;
                    
                    const response = await fetch('/api/debug/force-discovery', {
                        method: 'POST'
                    });
                    const result = await response.json();
                    
                    document.getElementById('sync-status').innerHTML = `
                        <div class="alert alert-success alert-sm">
                            Discovery complete! Found: ${result.result.discovered} new, Total: ${result.result.total}
                        </div>
                    `;
                    loadDashboardData();
                } catch (error) {
                    document.getElementById('sync-status').innerHTML = `
                        <div class="alert alert-danger alert-sm">
                            Discovery failed: ${error.message}
                        </div>
                    `;
                }
            }

            // Sync with network
            async function syncWithNetwork() {
                try {
                    const response = await fetch('/api/network/auto-sync', {
                        method: 'POST'
                    });

                    const result = await response.json();

                    document.getElementById('sync-status').innerHTML = `
                        <div class="alert alert-info alert-sm">
                            Sync completed. Network size: ${result.networkSize}, Local blocks: ${result.localBlocks}
                        </div>
                    `;
                    loadDashboardData(); // Refresh data
                } catch (error) {
                    document.getElementById('sync-status').innerHTML = `
                        <div class="alert alert-danger alert-sm">
                            Sync failed: ${error.message}
                        </div>
                    `;
                }
            }

            // Load dashboard data on page load
            loadDashboardData();
    </script>
</body>
</html>